<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>StillyLink</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<header class="navbar">
    <div class="logo">StillyLink</div>

    <nav class="nav-links">
        <a href="/">Главная</a>
        <a href="/chats/">Чаты</a>
        <a href="/index.html#create-chat">Создать чат</a>
        <a href="/anonymous/">Анонимное общение</a>
        <a href="/login/" class="register-btn">Регистрация</a>
    </nav>

    <div class="user-avatar hidden" onclick="toggleUserMenu()">
        <span>U</span>
    </div>

    <div class="user-menu">
        <a href="/profile/">Профиль</a>
        <a href="/mychats/">Мои чаты</a>
        <a href="#" id="logoutBtn">Выйти</a>
    </div>

    <div class="nav-toggle" onclick="toggleMenu()">☰</div>
</header>

<div class="menu-overlay"></div>

<section class="hero">
    <h1>StillyLink</h1>
    <p>Общайся свободно. Без регистрации. Полная анонимность.</p>

    <a href="#create-chat" class="hero-btn">Создать чат</a>
</section>

<section id="create-chat" class="section">
    <h2>Создать новый чат</h2>

    <div class="card">
        <input class="input" id="roomName" type="text" placeholder="Название чата">
        <input class="input" id="userName" type="text" placeholder="Ваш ник">
        <button class="btn" id="createBtn">Создать</button>
    </div>
</section>

<section class="section">
    <h2>Регистрация</h2>

    <div class="card">
        <input class="input" type="text" placeholder="Логин">
        <input class="input" type="password" placeholder="Пароль">
        <button class="btn">Зарегистрироваться</button>
    </div>
</section>

<footer class="footer">
    <p>© 2025 StillyLink. Все права защищены.</p>
</footer>

<!-- ============== FIREBASE (ОДНОКРАТНАЯ ИНИЦИАЛИЗАЦИЯ) ============== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { 
    getAuth,
    onAuthStateChanged,
    signOut
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

import { 
    getFirestore,
    collection,
    addDoc,
    serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

// --- CONFIG ---
const firebaseConfig = {
    apiKey: "AIzaSyBWlR4QWdnbqXLKKaftEAzhXneTmV9xXX0",
    authDomain: "stillylink-f1d0f.firebaseapp.com",
    projectId: "stillylink-f1d0f",
    storageBucket: "stillylink-f1d0f.appspot.com",
    messagingSenderId: "772070114710",
    appId: "1:772070114710:web:939bce83e4d3be14bdc9b7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// UI элементы
const regBtn = document.querySelector(".register-btn");
const avatar = document.querySelector(".user-avatar");
const avatarLetter = document.querySelector(".user-avatar span");
const userMenu = document.querySelector(".user-menu");
const logoutBtn = document.getElementById("logoutBtn");

    // === Локальное восстановление состояния ===
const savedLogin = localStorage.getItem("isLoggedIn");
const savedLetter = localStorage.getItem("avatarLetter");

if (savedLogin === "true" && savedLetter) {
    regBtn.classList.add("hidden");
    avatar.classList.remove("hidden");
    avatarLetter.textContent = savedLetter;
}

// --- Авторизация ---
onAuthStateChanged(auth, user => {
    if (user && user.email) {          // ← рисуем только реального пользователя
        const letter = user.email.charAt(0).toUpperCase();

        regBtn.classList.add("hidden");
        avatar.classList.remove("hidden");
        avatarLetter.textContent = letter;

        localStorage.setItem("isLoggedIn", "true");
        localStorage.setItem("avatarLetter", letter);
    } else {
        regBtn.classList.remove("hidden");
        avatar.classList.add("hidden");
        userMenu.classList.remove("open");

        localStorage.removeItem("isLoggedIn");
        localStorage.removeItem("avatarLetter");
    }
});

// --- Выход ---
logoutBtn.onclick = (e) => {
    e.preventDefault();

    localStorage.removeItem("isLoggedIn");
    localStorage.removeItem("avatarLetter");

    signOut(auth).then(() => window.location.reload());
};

// --- Создание чата ---
document.getElementById("createBtn").onclick = async () => {
    const roomName = document.getElementById("roomName").value.trim();
    const userName = document.getElementById("userName").value.trim();

    if (!roomName || !userName) {
        alert("Заполните все поля");
        return;
    }

    const docRef = await addDoc(collection(db, "rooms"), {
        name: roomName,
        createdAt: serverTimestamp()
    });

    window.location.href = `chat/?room=${docRef.id}&user=${encodeURIComponent(userName)}`;
};
</script>

<!-- ============== МЕНЮ НАВИГАЦИИ ============== -->
<script>
function toggleMenu() {
    const menu = document.querySelector(".nav-links");
    menu.classList.toggle("open");
}

document.addEventListener("click", function(e) {
    const menu = document.querySelector(".nav-links");
    const toggle = document.querySelector(".nav-toggle");

    if (!menu.classList.contains("open")) return;
    if (menu.contains(e.target) || toggle.contains(e.target)) return;

    menu.classList.remove("open");
});
</script>

<!-- ============== МЕНЮ АВАТАРКИ ============== -->
<script>
function toggleUserMenu() {
    document.querySelector(".user-menu").classList.toggle("open");
}

document.addEventListener("click", function(e) {
    const menu = document.querySelector(".user-menu");
    const avatar = document.querySelector(".user-avatar");

    if (!menu.classList.contains("open")) return;
    if (menu.contains(e.target) || avatar.contains(e.target)) return;

    menu.classList.remove("open");
});
</script>

</body>
</html>
