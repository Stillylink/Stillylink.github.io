<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Вход — StillyLink</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../style.css">
</head>
<body>
<div class="site-wrapper">
<header class="navbar">
    <div class="logo">StillyLink</div>

    <nav class="nav-links">
        <a href="/">Главная</a>
        <a href="/chats/">Чаты</a>
        <a href="../index.html#create-chat">Создать чат</a>
        <a href="/anonymous/">Анонимное общение</a>
        <a href="/login/">Регистрация</a>
    </nav>

    <div class="nav-toggle" onclick="toggleMenu()">☰</div>
</header>

<section class="section">
    <h2 style="color:#000">Вход / Регистрация</h2>

    <div class="card" style="max-width:420px;">
        <input id="email" class="input" type="email" placeholder="Email">
        <input id="password" class="input" type="password" placeholder="Пароль">

        <div id="errorMsg" style="
            color: #ff5555;
            margin-bottom: 10px;
            text-align: left;
            font-size: 14px;
            min-height: 18px;
        "></div>

        <button id="loginBtn" class="btn">Войти</button>
        <button id="registerBtn" class="btn" style="margin-top:10px;">Зарегистрироваться</button>

        <button id="resetPasswordBtn" class="btn" 
            style="margin-top:10px; background:#444;">
            Забыли пароль?
        </button>

        <hr style="margin:20px 0; border-color:#333;">

        <button id="googleBtn" class="btn" style="background:#fff; color:#000;">
            Войти через Google
        </button>
    </div>
</section>
</div>
<footer class="footer">
    <p>© 2025 StillyLink.</p>
</footer>
<style>
    #resetPasswordBtn {
        background: transparent !important;
        border: none;
        color: #d0d0d0 !important;
        font-size: 14px;
        cursor: pointer;
        text-decoration: underline;
        margin-top: 10px;
        padding: 4px 0;
        transition: 0.2s ease;
    }

    #resetPasswordBtn:hover {
        color: #ffffff !important;
    }
</style>

<!-- ===== Модальное окно добавления пароля ===== -->
<div id="passwordModal" style="
    display:none;
    position: fixed;
    left: 0; top: 0;
    width:100%; height:100%;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(3px);
    align-items: center;
    justify-content: center;
">
    <div style="
        background:#222;
        padding:20px 20px 18px;
        border-radius:12px;
        width:320px;
        box-shadow:0 0 15px rgba(0,0,0,0.3);
    ">
        <h3 style="color:#fff; margin-bottom:12px;">Создать пароль</h3>

        <input id="newPass" class="input" 
               type="password" 
               placeholder="Новый пароль (мин. 6 символов)"
               style="margin-bottom:6px;">

        <div id="modalError" style="
            color:#ff5555; 
            margin:4px 0 6px; 
            min-height:14px;
            font-size:14px;
        "></div>

        <button id="savePassBtn" class="btn" style="
            margin-top:4px; 
            width:100%;
        ">
            Сохранить пароль
        </button>

        <button id="cancelPassBtn" class="btn" style="
            margin-top:8px;
            width:100%;
            background:#444;
        ">
            Отмена
        </button>
    </div>
</div>

<!-- ===== Firebase Auth ===== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { 
    getAuth, 
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    GoogleAuthProvider,
    signInWithPopup,
    sendPasswordResetEmail,
    EmailAuthProvider,
    linkWithCredential
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBWlR4QWdnbqXLKKaftEAzhXneTmV9xXX0",
    authDomain: "stillylink-f1d0f.firebaseapp.com",
    projectId: "stillylink-f1d0f",
    storageBucket: "stillylink-f1d0f.appspot.com",
    messagingSenderId: "772070114710",
    appId: "1:772070114710:web:939bce83e4d3be14bdc9b7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

const emailInput = document.getElementById("email");
const passInput = document.getElementById("password");
const errorMsg = document.getElementById("errorMsg");

emailInput.addEventListener("input", () => errorMsg.textContent = "");
passInput.addEventListener("input", () => errorMsg.textContent = "");
    
function showError(code) {
    let msg = "";

    switch(code) {
        case "auth/invalid-email": msg = "Некорректный email."; break;
        case "auth/user-not-found": msg = "Аккаунт с таким email не найден."; break;
        case "auth/wrong-password": msg = "Неверный пароль."; break;
        case "auth/email-already-in-use": msg = "Аккаунт с таким email уже зарегистрирован."; break;
        case "auth/weak-password": msg = "Пароль должен содержать минимум 6 символов."; break;
        case "auth/missing-password": msg = "Введите пароль."; break;
        case "auth/invalid-credential": msg = "Неверный email или пароль."; break;
        default: msg = "Ошибка: " + code;
    }

    errorMsg.textContent = msg;
}

/* ---------- Регистрация ---------- */
document.getElementById("registerBtn").onclick = () => {
    errorMsg.textContent = "";
    const email = emailInput.value.trim();
    const pass = passInput.value.trim();

    createUserWithEmailAndPassword(auth, email, pass)
        .then(() => window.location.href = "../index.html")
        .catch(err => showError(err.code));
};

/* ---------- Вход ---------- */
document.getElementById("loginBtn").onclick = () => {
    errorMsg.textContent = "";
    const email = emailInput.value.trim();
    const pass = passInput.value.trim();

    signInWithEmailAndPassword(auth, email, pass)
        .then(() => window.location.href = "../index.html")
        .catch(err => showError(err.code));
};

/* ---------- Восстановление пароля ---------- */
document.getElementById("resetPasswordBtn").onclick = () => {
    const email = emailInput.value.trim();

    if (!email) {
        showError("auth/invalid-email");
        return;
    }

    sendPasswordResetEmail(auth, email)
        .then(() => alert("Ссылка для восстановления пароля отправлена на email."))
        .catch(err => showError(err.code));
};

/* ---------- Google вход ---------- */
document.getElementById("googleBtn").onclick = () => {
    errorMsg.textContent = "";

    signInWithPopup(auth, provider)
        .then(result => {
            const user = result.user;

            const hasPassword = user.providerData.some(p => p.providerId === "password");

            if (!hasPassword) {
                document.getElementById("passwordModal").style.display = "flex";
            } else {
                window.location.href = "../index.html";
            }
        })
        .catch(err => showError(err.code));
};

/* ---------- Создание пароля после Google-входа ---------- */

const saveBtn = document.getElementById("savePassBtn");
const cancelBtn = document.getElementById("cancelPassBtn");
const newPassInput = document.getElementById("newPass");
const modalError = document.getElementById("modalError");

newPassInput.addEventListener("input", () => {
    modalError.textContent = "";
});

// Сохранить пароль
saveBtn.onclick = () => {
    const newPass = newPassInput.value.trim();
    modalError.textContent = "";

    if (newPass.length < 6) {
        modalError.textContent = "Пароль должен быть минимум 6 символов.";
        return;
    }

    const user = auth.currentUser;
    const email = user.email;

    const cred = EmailAuthProvider.credential(email, newPass);

    linkWithCredential(user, cred)
        .then(() => {
            alert("Пароль успешно создан!");
            window.location.href = "../index.html";
        })
        .catch(err => modalError.textContent = "Ошибка: " + err.code);
};

// Отмена
cancelBtn.onclick = () => {
    document.getElementById("passwordModal").style.display = "none";
};
</script>

<script>
function toggleMenu() {
    const menu = document.querySelector(".nav-links");
    menu.classList.toggle("open");
}
</script>

</body>
</html>
