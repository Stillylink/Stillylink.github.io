<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ê–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç ‚Äî StillyLink</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- —Ç–≤–æ—è –æ—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∏–ª–∏—Å—Ç–∏–∫–∞ -->
<link rel="stylesheet" href="../style.css">

<style>
/* –ü–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥ —Ç–≤–æ–π –¥–∏–∑–∞–π–Ω */
body {
    background: var(--bg-page);
}

/* –û–±—ë—Ä—Ç–∫–∞ —á–∞—Ç–∞ */
.chat-wrapper {
    max-width: 700px;
    margin: 100px auto 40px;
    background: var(--bg-card);
    padding: 25px;
    border-radius: 16px;
    border: 1px solid var(--border);
    box-shadow: 0 0 12px rgba(0,0,0,0.3);
    display: none;
    flex-direction: column;
    height: 70vh;
}

/* –°–æ–æ–±—â–µ–Ω–∏—è */
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    color: var(--text-main);
}

/* –°–æ–æ–±—â–µ–Ω–∏–µ */
.message {
    margin-bottom: 12px;
    padding: 10px 14px;
    border-radius: 12px;
    max-width: 75%;
    line-height: 1.4;
    word-wrap: break-word;
}

/* –°–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è */
.me {
    background: var(--accent);
    color: #000;
    margin-left: auto;
}

/* –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ */
.them {
    background: var(--bg-hover);
    color: var(--text-main);
    margin-right: auto;
}

/* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
.chat-input {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.chat-input input {
    flex: 1;
    background: #151618;
    border: 1px solid var(--border);
    color: white;
    border-radius: 8px;
    padding: 12px;
}

.chat-input button {
    width: 60px;
}

/* –ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ */
.searching-box {
    margin-top: 150px;
    text-align: center;
    font-size: 22px;
    color: var(--text-main);
}

/* –ö–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —á–∞—Ç–∞ */
.end-buttons {
    display: none;
    flex-direction: column;
    gap: 12px;
    max-width: 300px;
    margin: 40px auto;
}

.btn-small {
    padding: 12px;
    border-radius: 10px;
}

/* –í–µ—Ä—Ö–Ω—è—è –∫–Ω–æ–ø–∫–∞ */
.top-exit {
    text-align: right;
    margin-top: 80px;
    width: 100%;
}

.top-exit button {
    background: #ff4f4f;
    color: white;
    padding: 7px 14px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    transition: 0.25s;
}

.top-exit button:hover {
    background: #ff7777;
}
</style>
</head>

<body>

<header class="navbar">
    <div class="logo">StillyLink</div>
</header>

<div class="top-exit">
    <button id="endChatBtn">–ó–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç</button>
</div>

<div class="searching-box" id="searchingBox">
    üîç –ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...
</div>

<div class="chat-wrapper" id="chatWrapper">
    <div class="chat-messages" id="chatMessages"></div>

    <div class="chat-input">
        <input type="text" id="msgInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="sendBtn" class="btn">‚û§</button>
    </div>
</div>

<div class="end-buttons" id="endButtons">
    <button id="newChatBtn" class="btn-small">–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç</button>
    <button id="exitBtn" class="btn-small">–í—ã–π—Ç–∏</button>
</div>


<!-- ================= FIREBASE ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
    getFirestore,
    collection,
    addDoc,
    deleteDoc,
    updateDoc,
    getDoc,
    getDocs,
    doc,
    onSnapshot,
    serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBWlR4QWdnbqXLKKaftEAzhXneTmV9xXX0",
    authDomain: "stillylink-f1d0f.firebaseapp.com",
    projectId: "stillylink-f1d0f",
    storageBucket: "stillylink-f1d0f.appspot.com",
    messagingSenderId: "772070114710",
    appId: "1:772070114710:web:939bce83e4d3be14bdc9b7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


// ======================================================
// ====== –õ–û–ì–ò–ö–ê –ü–û–õ–ù–û–°–¢–¨–Æ –ì–û–í–û–†–ò–¢ –ö–ê–ö –ú–´ –î–ï–õ–ê–õ–ò ========
// ======================================================

let roomId = null;
let myId = Math.random().toString(36).substring(2, 10);

async function findPartner() {
    const queueRef = collection(db, "anonQueue");

    const free = await getDocs(queueRef);
    let found = null;

    free.forEach(f => {
        const d = f.data();
        if (!d.busy) found = { id: f.id, ...d };
    });

    if (found) {
        roomId = found.room;
        await updateDoc(doc(db, "anonQueue", found.id), { busy: true });
        startChat(roomId);
    } else {
        const roomDoc = await addDoc(collection(db, "rooms"), {
            created: serverTimestamp(),
            activeUsers: 1
        });

        roomId = roomDoc.id;

        await addDoc(queueRef, {
            room: roomId,
            busy: false,
            creator: myId
        });

        // –∂–¥—ë–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ (–æ–±—Ä–∞–±–æ—Ç–∞–µ–º –Ω–∏–∂–µ)
    }
}

findPartner();


// =================== –°—Ç–∞—Ä—Ç —á–∞—Ç–∞ ======================
async function startChat(id) {
    roomId = id;

    document.getElementById("searchingBox").style.display = "none";
    document.getElementById("chatWrapper").style.display = "flex";

    const roomRef = doc(db, "rooms", roomId);
    const snap = await getDoc(roomRef);

    if (snap.exists()) {
        await updateDoc(roomRef, {
            activeUsers: (snap.data().activeUsers || 0) + 1
        });
    }

    const msgRef = collection(db, "rooms", roomId, "messages");
    onSnapshot(msgRef, snapshot => {
        const msgBox = document.getElementById("chatMessages");
        msgBox.innerHTML = "";

        snapshot.forEach(m => {
            const d = m.data();
            const div = document.createElement("div");
            div.className = "message " + (d.from === myId ? "me" : "them");
            div.textContent = d.text;
            msgBox.appendChild(div);
        });

        msgBox.scrollTop = msgBox.scrollHeight;
    });
}


// ================= –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è =================
document.getElementById("sendBtn").onclick = sendMessage;

document.getElementById("msgInput").addEventListener("keypress", (e)=>{
    if (e.key === "Enter") sendMessage();
});

async function sendMessage() {
    const input = document.getElementById("msgInput");
    const text = input.value.trim();
    if (!text) return;

    await addDoc(collection(db, "rooms", roomId, "messages"), {
        text,
        from: myId,
        time: serverTimestamp()
    });

    input.value = "";
}


// =============== –ó–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç =======================
document.getElementById("endChatBtn").onclick = () => {
    document.getElementById("chatWrapper").style.display = "none";
    document.getElementById("endButtons").style.display = "flex";
};


// =============== –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã ====================
async function deleteRoomCompletely() {
    if (!roomId) return;

    const roomRef = doc(db, "rooms", roomId);
    const snap = await getDoc(roomRef);

    if (!snap.exists()) return;

    let users = snap.data().activeUsers || 1;
    users--;

    if (users <= 0) {
        const msgs = await getDocs(collection(db, "rooms", roomId, "messages"));
        msgs.forEach(async msg => {
            await deleteDoc(doc(db, "rooms", roomId, "messages", msg.id));
        });

        await deleteDoc(roomRef);

        const q = await getDocs(collection(db, "anonQueue"));
        q.forEach(async qdoc => {
            let d = qdoc.data();
            if (d.room === roomId) await deleteDoc(doc(db, "anonQueue", qdoc.id));
        });

    } else {
        await updateDoc(roomRef, { activeUsers: users });
    }
}

document.getElementById("exitBtn").onclick = async () => {
    await deleteRoomCompletely();
    window.location.href = "/anonymous/";
};

document.getElementById("newChatBtn").onclick = async () => {
    await deleteRoomCompletely();
    window.location.reload();
};

</script>

</body>
</html>
