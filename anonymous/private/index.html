<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ê–Ω–æ–Ω–∏–º–Ω—ã–π –ß–∞—Ç ‚Äî StillyLink</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ======== –°–¢–ò–õ–ò –ù–ê –°–¢–ò–õ–¨ –í–ê–®–ï–ì–û –°–ê–ô–¢–ê ======== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: Arial, sans-serif;
}

:root {
    --bg-dark: #111214;
    --bg-page: #1a1c1f;
    --bg-card: #16181c;
    --text-light: #ffffff;
    --text-gray: #a7a7a7;
    --accent: #3a82f7;
}

body {
    background-color: var(--bg-page);
    color: var(--text-light);
    height: 100vh;
    display: flex;
    flex-direction: column;
}

/* HEADER */
.header {
    width: 100%;
    background: var(--bg-dark);
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header .exit-btn {
    color: #ff6666;
    cursor: pointer;
    font-size: 16px;
    text-decoration: none;
}

/* –ß–ê–¢ */
.chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
}

.message {
    max-width: 70%;
    padding: 10px 14px;
    margin-bottom: 10px;
    border-radius: 12px;
    line-height: 1.4;
    word-break: break-word;
}

.me {
    background: var(--accent);
    color: white;
    margin-left: auto;
}

.other {
    background: var(--bg-card);
}

/* –í–í–û–î */
.input-area {
    padding: 12px;
    background: var(--bg-dark);
    display: flex;
    gap: 10px;
}

.input-area input {
    flex: 1;
    padding: 12px;
    background: #222;
    color: white;
    border-radius: 8px;
    outline: none;
    border: 1px solid #333;
}

.input-area button {
    padding: 10px 16px;
    border-radius: 8px;
    background: var(--accent);
    color: white;
    border: none;
    cursor: pointer;
}

/* –ó–ê–í–ï–†–®–ï–ù–ò–ï –ß–ê–¢–ê */
.center-box {
    text-align: center;
    margin-top: 30px;
}

.center-box button,
.center-box a {
    background: var(--accent);
    padding: 12px 20px;
    border-radius: 12px;
    display: block;
    width: 200px;
    margin: 10px auto;
    color: white;
    text-decoration: none;
}

.hidden {
    display: none;
}

/* POPUP CONFIRM */
.confirm-popup {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: var(--bg-card);
    padding: 20px;
    border-radius: 14px;
    display: none;
    width: 260px;
    text-align: center;
}

.confirm-popup button {
    margin-top: 15px;
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
}

.confirm-popup .cancel {
    background: #444;
    color: white;
}

.confirm-popup .end {
    background: #ff4444;
    color: white;
}
</style>
</head>

<body>

<!-- HEADER -->
<header class="header">
    <div style="font-size: 18px;">StillyLink Chat</div>
    <a class="exit-btn" id="exitBtn">–í—ã–π—Ç–∏</a>
</header>

<!-- –ü–û–ò–°–ö –°–û–ë–ï–°–ï–î–ù–ò–ö–ê -->
<div id="searching" class="center-box">
    <h2>–ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...</h2>
</div>

<!-- –ß–ê–¢ -->
<div id="chatBox" class="chat-container hidden">
    <div class="messages" id="messages"></div>

    <div class="input-area">
        <button id="imgBtn">üì∑</button>
        <input id="msgInput" type="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="sendBtn">‚û§</button>
    </div>
</div>

<!-- –ü–û–°–õ–ï –ó–ê–í–ï–†–®–ï–ù–ò–Ø -->
<div id="afterEnd" class="center-box hidden">
    <h2>–ß–∞—Ç –∑–∞–≤–µ—Ä—à—ë–Ω</h2>
    <button id="newChatBtn">–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π</button>
    <a href="/anonymous/">–í—ã–π—Ç–∏</a>
</div>

<!-- POPUP -->
<div class="confirm-popup" id="confirmPopup">
    <div style="font-size: 18px;">–ó–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç?</div>
    <button class="end" id="confirmEnd">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    <button class="cancel" id="cancelEnd">–û—Ç–º–µ–Ω–∞</button>
</div>


<!-- FIREBASE -->
<script type="module">
import {
    initializeApp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
    getFirestore, doc, setDoc, getDoc, deleteDoc,
    updateDoc, onSnapshot, addDoc, collection, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDwn8NtOD5KKOFMx1ZzfR6jpkBh7jaCgFc",
    authDomain: "stillylink-firebase.firebaseapp.com",
    projectId: "stillylink-firebase",
    storageBucket: "stillylink-firebase.appspot.com",
    messagingSenderId: "350881944745",
    appId: "1:350881944745:web:61cacd2eea2b679dd9146f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* VARIABLES */
let myId = Math.random().toString(36).slice(2);
let roomRef = null;
let roomUnsub = null;
let msgUnsub = null;

/* ELEMENTS */
const searching = document.getElementById("searching");
const chatBox = document.getElementById("chatBox");
const messagesDiv = document.getElementById("messages");
const afterEnd = document.getElementById("afterEnd");

const sendBtn = document.getElementById("sendBtn");
const msgInput = document.getElementById("msgInput");

const exitBtn = document.getElementById("exitBtn");
const newChatBtn = document.getElementById("newChatBtn");

const confirmPopup = document.getElementById("confirmPopup");
const confirmEnd = document.getElementById("confirmEnd");
const cancelEnd = document.getElementById("cancelEnd");


/* START SEARCH */
async function startSearch() {

    searching.classList.remove("hidden");
    chatBox.classList.add("hidden");
    afterEnd.classList.add("hidden");

    // 1) –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ —Å–≤–æ–±–æ–¥–Ω—É—é –∫–æ–º–Ω–∞—Ç—É
    const roomsSnap = await getDocs(collection(db, "rooms"));
    let freeRoom = null;

    roomsSnap.forEach(r => {
        const d = r.data();
        if (d.participants.length === 1) freeRoom = r;
    });

    if (freeRoom) {
        roomRef = doc(db, "rooms", freeRoom.id);
        await updateDoc(roomRef, {
            participants: [...freeRoom.data().participants, myId]
        });
        startRoomListener();
        return;
    }

    // 2) –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É
    const newRoom = doc(collection(db, "rooms"));
    roomRef = newRoom;

    await setDoc(roomRef, {
        participants: [myId],
        created: Date.now()
    });

    startRoomListener();
}


/* ROOM LISTENER */
function startRoomListener() {
    roomUnsub = onSnapshot(roomRef, async (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();

        if (data.participants.length === 2) {
            searching.classList.add("hidden");
            chatBox.classList.remove("hidden");

            startMessagesListener();
        }
    });
}

/* MESSAGES LISTENER */
function startMessagesListener() {
    const msgsRef = collection(roomRef, "messages");

    msgUnsub = onSnapshot(msgsRef, (snapshot) => {
        messagesDiv.innerHTML = "";

        snapshot.forEach(m => {
            const d = m.data();
            const div = document.createElement("div");
            div.classList.add("message");
            div.classList.add(d.sender === myId ? "me" : "other");
            div.innerText = d.text;
            messagesDiv.appendChild(div);
        });

        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
}


/* SEND MESSAGE */
sendBtn.onclick = async () => {
    if (!msgInput.value.trim()) return;

    const text = msgInput.value;
    msgInput.value = "";

    await addDoc(collection(roomRef, "messages"), {
        sender: myId,
        text,
        time: Date.now()
    });
};


/* CLEAR ALL LISTENERS */
async function clearAllState() {
    if (roomUnsub) roomUnsub();
    if (msgUnsub) msgUnsub();

    roomUnsub = null;
    msgUnsub = null;
}


/* CLEANUP ROOM COMPLETELY */
async function fullRoomCleanup() {
    if (!roomRef) return;

    const snap = await getDoc(roomRef);
    if (!snap.exists()) return;

    const data = snap.data();
    const part = data.participants || [];

    if (part.length <= 1) {
        // —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
        const msgs = await getDocs(collection(roomRef, "messages"));
        for (const m of msgs.docs) await deleteDoc(m.ref);

        // —É–¥–∞–ª–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É
        await deleteDoc(roomRef);
    }
}


/* EXIT */
exitBtn.onclick = async () => {
    await fullRoomCleanup();
    await clearAllState();
    location.href = "/anonymous/";
};


/* CONFIRM POPUP */
exitBtn.addEventListener("click", (e) => {
    e.preventDefault();
    confirmPopup.style.display = "block";
});

cancelEnd.onclick = () => {
    confirmPopup.style.display = "none";
};

confirmEnd.onclick = async () => {
    confirmPopup.style.display = "none";
    await fullRoomCleanup();
    await clearAllState();

    chatBox.classList.add("hidden");
    afterEnd.classList.remove("hidden");
};


/* NEW CHAT */
newChatBtn.onclick = async () => {
    await fullRoomCleanup();
    await clearAllState();
    startSearch();
};


/* LAUNCH */
startSearch();

</script>

</body>
</html>
