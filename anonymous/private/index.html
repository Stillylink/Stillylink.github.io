<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ê–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç ‚Äî StillyLink</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="../style.css">

<style>
.chat-wrapper {
    max-width: 600px;
    margin: 80px auto;
    background: var(--bg-card);
    padding: 20px;
    border-radius: 16px;
    display: none;
    flex-direction: column;
    height: 70vh;
}
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    color: #fff;
}
.message {
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 10px;
    max-width: 80%;
}
.me {
    background: #3a57e8;
    margin-left: auto;
}
.them {
    background: #2a2c31;
    margin-right: auto;
}
.chat-input {
    display: flex;
    gap: 10px;
}
.chat-input input {
    flex: 1;
}
.searching-box {
    margin-top: 120px;
    text-align: center;
    font-size: 20px;
    color: #fff;
}
.end-buttons {
    display: none;
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
}
.btn-small {
    padding: 10px;
    border-radius: 10px;
}
.top-exit {
    text-align: right;
    margin-top: 80px;
}
.top-exit button {
    background: #ff4f4f;
    color: white;
    padding: 6px 12px;
    border-radius: 10px;
    border: none;
}
</style>
</head>

<body>

<header class="navbar">
    <div class="logo">StillyLink</div>
</header>

<div class="top-exit">
    <button id="endChatBtn">–ó–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç</button>
</div>

<div class="searching-box" id="searchingBox">
    üîç –ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...
</div>

<div class="chat-wrapper" id="chatWrapper">
    <div class="chat-messages" id="chatMessages"></div>

    <div class="chat-input">
        <input type="text" id="msgInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="sendBtn" class="btn">‚û§</button>
    </div>
</div>

<div class="end-buttons" id="endButtons">
    <button id="newChatBtn" class="btn-small">–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç</button>
    <button id="exitBtn" class="btn-small">–í—ã–π—Ç–∏</button>
</div>


<!-- ================= FIREBASE ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
    getFirestore,
    collection,
    addDoc,
    deleteDoc,
    updateDoc,
    getDoc,
    getDocs,
    doc,
    onSnapshot,
    serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBWlR4QWdnbqXLKKaftEAzhXneTmV9xXX0",
    authDomain: "stillylink-f1d0f.firebaseapp.com",
    projectId: "stillylink-f1d0f",
    storageBucket: "stillylink-f1d0f.appspot.com",
    messagingSenderId: "772070114710",
    appId: "1:772070114710:web:939bce83e4d3be14bdc9b7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


// ======================================================
// =============== –ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ ====================
// ======================================================
let roomId = null;
let myId = Math.random().toString(36).substring(2, 10);
let connected = false;

async function findPartner() {
    const queueRef = collection(db, "anonQueue");

    // –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ
    const free = await getDocs(queueRef);
    let found = null;

    free.forEach(f => {
        const d = f.data();
        if (!d.busy) found = { id: f.id, ...d };
    });

    if (found) {
        // —Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è
        roomId = found.room;
        await updateDoc(doc(db, "anonQueue", found.id), { busy: true });
        startChat(roomId, false);
    } else {
        // —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É
        const roomDoc = await addDoc(collection(db, "rooms"), {
            created: serverTimestamp(),
            activeUsers: 1
        });

        roomId = roomDoc.id;

        // –∫–ª–∞–¥—ë–º –≤ –æ—á–µ—Ä–µ–¥—å
        await addDoc(queueRef, {
            room: roomId,
            busy: false,
            creator: myId
        });

        // —Å–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏
        free.forEach(() => {});
    }
}

findPartner();


// ======================================================
// =================== –°—Ç–∞—Ä—Ç —á–∞—Ç–∞ =======================
// ======================================================

async function startChat(id, isCreator = true) {
    connected = true;
    roomId = id;
    document.getElementById("searchingBox").style.display = "none";
    document.getElementById("chatWrapper").style.display = "flex";

    // –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ
    const roomRef = doc(db, "rooms", roomId);
    const snap = await getDoc(roomRef);
    if (snap.exists()) {
        await updateDoc(roomRef, {
            activeUsers: (snap.data().activeUsers || 0) + 1
        });
    }

    // —Å–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
    const msgRef = collection(db, "rooms", roomId, "messages");
    onSnapshot(msgRef, snapshot => {
        const msgBox = document.getElementById("chatMessages");
        msgBox.innerHTML = "";

        snapshot.forEach(m => {
            const d = m.data();
            const div = document.createElement("div");
            div.className = "message " + (d.from === myId ? "me" : "them");
            div.textContent = d.text;
            msgBox.appendChild(div);
        });

        msgBox.scrollTop = msgBox.scrollHeight;
    });
}


// ======================================================
// ================= –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è =================
// ======================================================
document.getElementById("sendBtn").onclick = sendMessage;

document.getElementById("msgInput").addEventListener("keypress", (e)=>{
    if (e.key === "Enter") sendMessage();
});

async function sendMessage() {
    const input = document.getElementById("msgInput");
    const text = input.value.trim();
    if (!text) return;

    await addDoc(collection(db, "rooms", roomId, "messages"), {
        text,
        from: myId,
        time: serverTimestamp()
    });

    input.value = "";
}


// ======================================================
// =============== –ó–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è) =========
// ======================================================
document.getElementById("endChatBtn").onclick = () => {
    document.getElementById("chatWrapper").style.display = "none";
    document.getElementById("endButtons").style.display = "flex";
};


// ======================================================
// ========== –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã + —Å–æ–æ–±—â–µ–Ω–∏–π ==============
// ======================================================
async function deleteRoomCompletely() {
    if (!roomId) return;

    const roomRef = doc(db, "rooms", roomId);
    const snap = await getDoc(roomRef);

    if (!snap.exists()) return;

    let users = snap.data().activeUsers || 1;
    users--;

    if (users <= 0) {
        // —É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
        const msgs = await getDocs(collection(db, "rooms", roomId, "messages"));
        msgs.forEach(async msg => {
            await deleteDoc(doc(db, "rooms", roomId, "messages", msg.id));
        });

        // —É–¥–∞–ª—è–µ–º –∫–æ–º–Ω–∞—Ç—É
        await deleteDoc(roomRef);

        // —á–∏—Å—Ç–∏–º –æ—á–µ—Ä–µ–¥—å
        const q = await getDocs(collection(db, "anonQueue"));
        q.forEach(async qdoc => {
            let d = qdoc.data();
            if (d.room === roomId) {
                await deleteDoc(doc(db, "anonQueue", qdoc.id));
            }
        });
    } else {
        await updateDoc(roomRef, { activeUsers: users });
    }
}


// ======================================================
// ================== –ö–Ω–æ–ø–∫–∞ "–í—ã–π—Ç–∏" ====================
// ======================================================
document.getElementById("exitBtn").onclick = async () => {
    await deleteRoomCompletely();
    window.location.href = "/anonymous/";
};


// ======================================================
// =========== –ö–Ω–æ–ø–∫–∞ ¬´–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç¬ª ================
// ======================================================
document.getElementById("newChatBtn").onclick = async () => {
    await deleteRoomCompletely();
    window.location.reload();
};

</script>

</body>
</html>
